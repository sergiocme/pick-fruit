<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pick Fruit</title>

  <style>
    html,
    body {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      margin: 0;
    }

    #screen {
      width: 400px;
      height: 400px;
      border: 10px solid #ccc;
      image-rendering: pixelated;
    }
  </style>
</head>
<body>
  <canvas id="screen" width="10" height="10"></canvas>

  <script type="module">
    import createInput from './inputFactory.js';
    import createCanvas from './canvasFactory.js';

    function createGame() {
      const state = {
        players: {},
        fruits: {},
        fieldLimit: {
          topEdge: 0,
          rightEdge: 9,
          bottomEdge: 9,
          leftEdge: 0,
        },
      };

      function addPlayer({ id, positionX, positionY }) {
        state.players[id] = {
          positionX,
          positionY,
        };
      }

      function removePlayer({ id }) {
        delete state.players[id];
      }

      function addFruit({ id, positionX, positionY }) {
        state.fruits[id] = {
          positionX,
          positionY,
        };
      }

      function removeFruit({ id }) {
        delete state.fruits[id];
      }

      function checkFruitCollision({ id }) {
        const player = state.players[id];

        for (const fruitKey in state.fruits) {
          const fruit = state.fruits[fruitKey];

          if (fruit.positionX === player.positionX && fruit.positionY === player.positionY) {
            removeFruit({ id: fruitKey });
          }
        }
      }

      function movementValidator(updatedPlayer) {
        let validX = false;
        let validY = false;
        for (const limit in state.fieldLimit) {
          validX = updatedPlayer.positionX > -1 && updatedPlayer.positionX < 10 ? true : false;
          validY = updatedPlayer.positionY > -1 && updatedPlayer.positionY < 10 ? true : false;
        }

        return (validX && validY);
      }

      function movePlayer({ pressedKey }) {
        const player = state.players['player1'];
        const moves = {
          ArrowUp: {
            movement(player) {
              const updatedPlayer = {
                ...player,
                positionY: player.positionY - 1,
              };

              const validMove = movementValidator(updatedPlayer)
              if (validMove) {
                state.players['player1'] = updatedPlayer;
              }
            },
          },
          ArrowRight: {
            movement(player) {
              const updatedPlayer = {
                ...player,
                positionX: player.positionX + 1,
              };

              const validMove = movementValidator(updatedPlayer)
              if (validMove) {
                state.players['player1'] = updatedPlayer;
              }
            },
          },
          ArrowDown: {
            movement(player) {
              const updatedPlayer = {
                ...player,
                positionY: player.positionY + 1,
              };

              const validMove = movementValidator(updatedPlayer)
              if (validMove) {
                state.players['player1'] = updatedPlayer;
              }
            },
          },
          ArrowLeft: {
            movement(player) {
              const updatedPlayer = {
                ...player,
                positionX: player.positionX - 1,
              };

              const validMove = movementValidator(updatedPlayer)
              if (validMove) {
                state.players['player1'] = updatedPlayer;
              }
            },
          },
        };

        if (player && moves[pressedKey]) {
          moves[pressedKey].movement(player);
          checkFruitCollision({ id: 'player1' });
        }
      }

      return {
        state,
        movePlayer,
        addPlayer,
        removePlayer,
        addFruit,
        removeFruit,
      };
    }

    const game = createGame();
    const input = createInput(document);
    input.subcribe(game.movePlayer);
    const canvas = createCanvas(document, game.state);

    game.addPlayer({
      id: 'player1',
      positionX: 0,
      positionY: 0,
    });

    game.addFruit({
      id: 'fruit1',
      positionX: 3,
      positionY: 7,
    });

    canvas.startRender();
  </script>
</body>
</html>
